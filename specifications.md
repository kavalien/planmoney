# Спецификации Телеграм Бота для Учета Финансов

## 1. Обзор проекта

### Цель
Создание телеграм бота для совместного ведения учета финансов двумя пользователями с автоматической записью данных в Google Таблицы.

### Ключевые функции
- Прием сообщений о тратах и доходах от двух пользователей
- Автоматическая категоризация операций
- Запись данных в Google Таблицы
- Простой интерфейс через Telegram

## 2. Функциональные требования

### 2.1 Авторизация и доступ
- [ ] Бот должен работать только с двумя авторизованными пользователями (вы и ваша девушка)
- [ ] Проверка Telegram ID пользователей при каждом взаимодействии
- [ ] Отклонение запросов от неавторизованных пользователей

### 2.2 Обработка сообщений
- [ ] Распознавание сообщений о тратах (например: "потратил 500 руб на продукты")
- [ ] Распознавание сообщений о доходах (например: "получил 10000 руб зарплата")
- [ ] Извлечение суммы, категории и описания из текста
- [ ] Подтверждение записи операции пользователю

### 2.3 Категории операций

#### Категории трат:
- [ ] Продукты питания
- [ ] Транспорт
- [ ] Развлечения
- [ ] Одежда
- [ ] Здоровье/медицина
- [ ] Коммунальные услуги
- [ ] Прочие расходы

#### Категории доходов:
- [ ] Зарплата
- [ ] Подработка
- [ ] Прочие доходы

### 2.4 Команды бота
- [ ] `/start` - приветствие и инструкция
- [ ] `/help` - справка по использованию
- [ ] `/stats` - краткая статистика за месяц
- [ ] `/categories` - список доступных категорий
- [ ] `/balance` - текущий баланс

## 3. Интеграция с Google Таблицами

### 3.1 Структура таблицы
- [ ] Колонка "Дата" (дата операции)
- [ ] Колонка "Пользователь" (кто совершил операцию)
- [ ] Колонка "Тип" (доход/расход)
- [ ] Колонка "Сумма" (сумма операции)
- [ ] Колонка "Категория" (категория операции)
- [ ] Колонка "Описание" (дополнительное описание)
- [ ] Колонка "Telegram ID" (ID сообщения для связи)

### 3.2 API требования
- [ ] Использование Google Sheets API
- [ ] Настройка сервисного аккаунта Google
- [ ] Обработка ошибок при записи в таблицу
- [ ] Автоматическое создание новых листов по месяцам

## 4. Файловая структура проекта

```
planmoney/
├── bot/
│   ├── __init__.py
│   ├── main.py                    # Точка входа в приложение
│   ├── config.py                  # Конфигурация и настройки
│   ├── handlers/
│   │   ├── __init__.py
│   │   ├── messages.py            # Обработчики текстовых сообщений
│   │   ├── commands.py            # Обработчики команд (/start, /help и т.д.)
│   │   └── errors.py              # Обработчики ошибок
│   ├── middlewares/
│   │   ├── __init__.py
│   │   ├── auth.py                # Middleware для авторизации пользователей
│   │   └── logging.py             # Middleware для логирования
│   ├── utils/
│   │   ├── __init__.py
│   │   ├── parser.py              # Парсинг сообщений (извлечение суммы, категории)
│   │   ├── categories.py          # Определение и обработка категорий
│   │   └── validators.py          # Валидация данных
│   ├── services/
│   │   ├── __init__.py
│   │   ├── google_sheets.py       # Интеграция с Google Sheets
│   │   ├── database.py            # Работа с локальной БД (опционально)
│   │   └── statistics.py          # Генерация статистики
│   └── models/
│       ├── __init__.py
│       ├── transaction.py         # Модель финансовой операции
│       └── user.py                # Модель пользователя
├── tests/
│   ├── __init__.py
│   ├── test_parser.py             # Тесты парсера сообщений
│   ├── test_categories.py         # Тесты категоризации
│   ├── test_google_sheets.py      # Тесты интеграции с Google Sheets
│   └── test_handlers.py           # Тесты обработчиков
├── docs/
│   ├── setup.md                   # Инструкция по настройке
│   ├── api_reference.md           # Документация API
│   └── user_guide.md              # Руководство пользователя
├── credentials/
│   └── google_service_account.json # Google Service Account ключи (не в git)
├── logs/
│   └── bot.log                    # Файлы логов
├── .env                           # Переменные окружения (не в git)
├── .env.example                   # Пример файла окружения
├── .gitignore                     # Игнорируемые файлы
├── requirements.txt               # Python зависимости
├── specifications.md              # Текущий файл спецификаций
├── README.md                      # Описание проекта
└── run.py                         # Скрипт запуска бота
```

### 4.1 Описание компонентов

#### Основные модули:
- **`bot/main.py`** - главный файл запуска бота с инициализацией
- **`bot/config.py`** - загрузка конфигурации из переменных окружения
- **`run.py`** - скрипт для удобного запуска бота

#### Обработчики (handlers):
- **`messages.py`** - обработка текстовых сообщений о тратах и доходах
- **`commands.py`** - обработка команд бота (/start, /help, /stats и т.д.)
- **`errors.py`** - централизованная обработка ошибок

#### Утилиты (utils):
- **`parser.py`** - извлечение суммы, категории и описания из текста
- **`categories.py`** - определение категорий операций
- **`validators.py`** - валидация входных данных

#### Сервисы (services):
- **`google_sheets.py`** - работа с Google Sheets API
- **`database.py`** - локальное кэширование (SQLite)
- **`statistics.py`** - генерация отчетов и статистики

#### Модели данных (models):
- **`transaction.py`** - структура финансовой операции
- **`user.py`** - информация о пользователе

#### Middleware:
- **`auth.py`** - проверка авторизации пользователей
- **`logging.py`** - логирование всех действий

## 5. Технические требования

### 5.1 Технологический стек
- [ ] Python 3.8+
- [ ] aiogram библиотека (асинхронная библиотека для Telegram Bot API)
- [ ] Google Sheets API (gspread)
- [ ] Natural Language Processing для извлечения данных из текста
- [ ] SQLite для локального кэширования (опционально)
- [ ] asyncio для асинхронной обработки запросов

### 5.2 Конфигурация
- [ ] Переменные окружения для токенов и ключей
- [ ] Файл конфигурации для категорий и настроек
- [ ] Логирование всех операций

### 5.3 Безопасность
- [ ] Безопасное хранение API токенов
- [ ] Валидация входных данных
- [ ] Ограничение доступа по Telegram ID

## 6. Пользовательский интерфейс

### 6.1 Формат сообщений

#### Примеры сообщений о тратах:
- "потратил 500 руб на продукты"
- "купила кофе 150р"
- "такси 300 рублей"
- "500₽ продукты в Пятерочке"

#### Примеры сообщений о доходах:
- "получил зарплату 50000 руб"
- "подработка 5000р"
- "+10000 руб зарплата"

### 6.2 Ответы бота
- [ ] Подтверждение записи операции
- [ ] Уточняющие вопросы при неясности
- [ ] Сообщения об ошибках в понятном формате

## 7. Обработка ошибок

### 7.1 Типы ошибок
- [ ] Неопознанный формат сообщения
- [ ] Ошибки подключения к Google Sheets
- [ ] Неавторизованный пользователь
- [ ] Некорректная сумма или категория

### 7.2 Стратегии обработки
- [ ] Переспрос пользователя при неясности
- [ ] Повторные попытки при сетевых ошибках
- [ ] Сохранение данных локально при недоступности Google Sheets

## 8. Расширенные функции (будущие версии)

### 8.1 Аналитика
- [ ] Графики трат по категориям
- [ ] Сравнение трат по месяцам
- [ ] Уведомления о превышении бюджета

### 8.2 Дополнительные возможности
- [ ] Планирование бюджета
- [ ] Напоминания о регулярных платежах
- [ ] Экспорт данных в различных форматах
- [ ] Интеграция с банковскими API

## 9. План разработки

### Этап 1 (MVP)
- [ ] Базовая настройка бота
- [ ] Простая обработка текстовых сообщений
- [ ] Интеграция с Google Sheets
- [ ] Авторизация пользователей

### Этап 2
- [ ] Улучшенное распознавание сообщений
- [ ] Дополнительные команды
- [ ] Обработка ошибок

### Этап 3
- [ ] Статистика и отчеты
- [ ] Дополнительные категории
- [ ] Оптимизация производительности

## 10. Тестирование

### 10.1 Виды тестов
- [ ] Тестирование обработки сообщений
- [ ] Тестирование интеграции с Google Sheets
- [ ] Тестирование авторизации
- [ ] Нагрузочное тестирование

### 10.2 Тестовые сценарии
- [ ] Различные форматы сообщений о тратах
- [ ] Обработка некорректных данных
- [ ] Работа при недоступности внешних сервисов

## 11. Развертывание

### 11.1 Требования к хостингу
- [ ] Python runtime
- [ ] Постоянное интернет-соединение
- [ ] Возможность работы с webhook или polling

### 11.2 Варианты развертывания
- [ ] Heroku
- [ ] VPS сервер
- [ ] Google Cloud Platform
- [ ] Локальный сервер

---

**Версия:** 1.0  
**Дата создания:** 2025-09-06  
**Статус:** В разработке